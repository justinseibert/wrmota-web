{% extends 'site/layout/default.html' %}
{% block body %}
{% raw %}
<header id="_home" class="page-portion">
  <h1>West Reading <br class="u-mobile">Museum of <br class="u-mobile">Temporary Art</h1>
  <hr>
  <p>A borough-wide mural art project featuring over 100 public works created by artists from around the world</p>
  <p>Download the app to explore the artwork of WRMOTA and listen to stories from the community that inspired it.</p>
  <p>
    <a href="https://itunes.apple.com/us/app/wrmota/id1373824275?mt=8">
      <img class="dl-badge" alt='Download on the App Store' src="/img/icon/badge-ios.svg"></a>
    <a href='https://play.google.com/store/apps/details?id=org.wrmota.app'>
      <img class="dl-badge" alt='Get it on Google Play' src='/img/icon/badge-android.png'/>
    </a>
  </p>
  <p class="break-heavy frame-heavy unframe-x unframe-top" v-show="!showMore">
    <a onclick="vInfo.show();vFoot.show()" class="nav-button frame-heavy unframe-x unframe-top">
      Learn More
      <svg-arrow-down></svg-arrow-down>
    </a>
  </p>
</header>

<div id="_info" class="page-portion info" ref="_moreInfo" v-show="showMore">
  <div class="info-row break-medium">
    <div class="info-block">
      <h2>About the Project</h2>
      <p>West Reading Museum of Temporary Art seeks to unearth personal histories of the borough that would otherwise remain unrecorded.</p>
    </div>

    <section id="_audioPlayer" class="card player-controls info-block" v-show="artist">
      <img src="/img/sofie-ramos.jpg">
      <div class="u-flex frame-medium" v-if="artist">
        <button class="play-button">
          <svg-loading v-if="audio.state=='loading'"></svg-loading>
          <svg-play v-if="audio.state=='ready'"></svg-play>
          <svg-pause v-if="audio.state=='playing'"></svg-pause>
        </button>
        <div class="frame-medium unframe-y">
          <h1>{{ artist.address }}</h1>
          <h2>{{ artist.artist_name }}</h2>
        </div>
      </div>
      <div class="frame-medium playback">
        <svg-rewind></svg-rewind>
        <div class="audio-playback-bar">
          <div class="audio-progress"></div>
        </div>
        <svg-fastforward></svg-fastforward>
      </div>
    </section>
  </div>

  <section class="row">
    <p class="ten grid">During the summer of 2018, WRMOTA invites neighbors and vistors alike to explore the streets of West Reading, PA in search of a selection of brick-sized murals installed on the walls of homes and businesses.</p>
    <p class="four grid u-right">
      <a href="/map" class="button nav-button full-button orange">
        View Map
        <svg-arrow-forward></svg-arrow-forward>
      </a></p>
  </section>

  <section class="row">
    <p>Each mural is a response to a story told by a local site-owner that reflects a memory related to the specific location.</p>
    <p>Themes of community, nostalgia, connection and loss arise from the dozens of catalogues stories collected across generations and interpreted by artists from Spain, Germany, the Netherlands, UK and all over the United States, including a selection of local Berks County participants.</p>
    <p class="four grid u-float-right">
      <a href="/artists" class="button nav-button green full-button">
        View Artists
        <svg-arrow-forward></svg-arrow-forward>
      </a>
    </p>
  </section>
</div>
{% endraw %}
{% endblock body %}

{% block script %}
<script>
  var vInfo = new Vue({
    el: '#_main',
    data: {
      showMore: false,
      codedData: false,
      code: 'AABC',
      artist: false,
      errors: [],
      fetch_attempt: 0,
      email: {
        submission: null,
        address: '',
      },
      audio: {
        current: null,
        state: 'loading',
        progress: 0,
        files: {},
        duration: 0,
      }
    },
    methods: {
      show: function(){
        this.showMore = true;
        this.$nextTick(function(){
          window.scroll({
            top: this.$refs._moreInfo.offsetTop,
            behavior: 'smooth'
          });
        });
      },
      getArtist: function(){
        if (!this.artist) {
          this.getData();
        } else  {
          return this.artist;
        }
      },
      loadAudio: function(){
        console.log(this.artist);
        var file = [
          'https://wrmota.org/media/',
          this.artist.audio_directory,
          this.artist.audio_file
        ].join('');

        console.log(file);
        var id = this.artist.audio_file;
        if (!this.audio[id]){
          this.audio.files[id] = new Howl({
            src: [
              file+'.mp3',
              file+'.webm',
              file+'.ogg',
              file+'.m4a'
            ],
            html5: true
          });
        } else {
          this.audio.state = 'ready';
        }
        this.audio.current = this.audio.files[id];
        this.progress = 0;

        var $this = this;
        this.audio.current.on('load', function(){
          $this.audio.state = 'ready'
        });
        this.audio.current.on('end', function(){
          $this.audio.state = 'ready'
        });
      },
      getData: function(){
        var vm = this;
        vm.fetch_attempt++;
        $.ajax({
          type: 'GET',
          url: 'https://wrmota.org/api/v1/get/all',
          success: function(data){
            vm.codedData = data.codes.data;
            vm.artist = vm.codedData[vm.code][0];
            vm.loadAudio();
          },
          error: function(error){
            console.log('xhr error');
            vm.errors.push(error);
            if (vm.fetch_attempt < 3){
              vm.getArtist();
            }
          }
        });
      },
    },
    created: function() {
      this.artist = this.getArtist();
    }
  });
</script>
{% endblock script %}
